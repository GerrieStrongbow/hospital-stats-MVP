<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Record Creation Test - Hospital Stats MVP</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f9f9f9;
        }
        .test-step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007bff;
            background: white;
        }
        .expected {
            color: #28a745;
            font-weight: bold;
        }
        .warning {
            color: #ffc107;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .code {
            background: #f1f1f1;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        .form-data {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <h1>üß™ Patient Record Creation Test</h1>
    <p>This test verifies that patient records can be created and saved to the Supabase database correctly after the recent bug fixes.</p>

    <div class="test-section">
        <h2>üìã Test Overview</h2>
        <p>We'll test the complete patient record creation flow including:</p>
        <ul>
            <li>Form rendering with proper facility options</li>
            <li>Dynamic facility loading based on user's sub-district</li>
            <li>Form validation and data collection</li>
            <li>Database insertion and verification</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîß Test Environment Setup</h2>
        <div class="test-step">
            <strong>Step 1:</strong> Initialize Supabase client
            <button onclick="initializeSupabase()">Initialize Supabase</button>
            <div id="supabase-status" class="status info">Click to initialize...</div>
        </div>
        
        <div class="test-step">
            <strong>Step 2:</strong> Check user authentication
            <button onclick="checkAuthentication()">Check Auth</button>
            <div id="auth-status" class="status info">Click to check...</div>
        </div>

        <div class="test-step">
            <strong>Step 3:</strong> Verify user profile and sub-district
            <button onclick="checkUserProfile()">Check Profile</button>
            <div id="profile-status" class="status info">Click to check...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üìù Patient Form Test</h2>
        <div class="test-step">
            <strong>Step 4:</strong> Test facility options loading
            <button onclick="testFacilityOptions()">Test Facility Loading</button>
            <div id="facility-status" class="status info">Click to test...</div>
        </div>

        <div class="test-step">
            <strong>Step 5:</strong> Create sample patient record
            <button onclick="createSamplePatient()">Create Sample Patient</button>
            <div id="create-status" class="status info">Click to create...</div>
            
            <div class="form-data">
                <strong>Sample Patient Data:</strong><br>
                ‚Ä¢ Patient ID: TEST-PATIENT-001<br>
                ‚Ä¢ Age Group: >18<br>
                ‚Ä¢ Facility Type: phc<br>
                ‚Ä¢ Facility: Will be auto-selected from Stellenbosch facilities<br>
                ‚Ä¢ Appointment Date: Today<br>
                ‚Ä¢ Appointment Type: new<br>
                ‚Ä¢ Referral Source: hospital<br>
                ‚Ä¢ Clinical Area: General Medicine<br>
                ‚Ä¢ Attendance: Attended<br>
                ‚Ä¢ Disposal: Future Appointment Given<br>
                ‚Ä¢ Outcome: Assessment Completed
            </div>
        </div>

        <div class="test-step">
            <strong>Step 6:</strong> Verify record in database
            <button onclick="verifyPatientRecord()">Verify in Database</button>
            <div id="verify-status" class="status info">Click to verify...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üßπ Test Cleanup</h2>
        <div class="test-step">
            <strong>Step 7:</strong> Clean up test data
            <button onclick="cleanupTestData()">Cleanup Test Data</button>
            <div id="cleanup-status" class="status info">Click to cleanup...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üìä Test Results Summary</h2>
        <div id="test-summary" class="status info">
            Run all test steps above to see results...
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabase = null;
        let currentUser = null;
        let userProfile = null;
        let testPatientId = null;

        // Test results tracking
        const testResults = {
            supabaseInit: false,
            authCheck: false,
            profileCheck: false,
            facilityTest: false,
            patientCreate: false,
            recordVerify: false,
            cleanup: false
        };

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.innerHTML = message;
        }

        function updateSummary() {
            const passed = Object.values(testResults).filter(r => r === true).length;
            const total = Object.keys(testResults).length;
            const summaryEl = document.getElementById('test-summary');
            
            if (passed === total) {
                summaryEl.className = 'status success';
                summaryEl.innerHTML = `‚úÖ All tests passed! (${passed}/${total})`;
            } else if (passed > 0) {
                summaryEl.className = 'status error';
                summaryEl.innerHTML = `‚ö†Ô∏è Some tests failed: ${passed}/${total} passed`;
            } else {
                summaryEl.className = 'status info';
                summaryEl.innerHTML = `üìä Tests not yet run: ${passed}/${total} completed`;
            }
        }

        async function initializeSupabase() {
            try {
                // Use the same configuration as the main app
                const supabaseUrl = 'https://jzclgjdujdlgsocokjkf.supabase.co';
                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6Y2xnamR1amRsZ3NvY29ramtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc0Nzk5ODksImV4cCI6MjA1MzA1NTk4OX0.VJp_x_PWFPr4yyqMwprhx7jJu1EuE-FvLtFnKAUz2OU';
                
                supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                
                updateStatus('supabase-status', '‚úÖ Supabase client initialized successfully', 'success');
                testResults.supabaseInit = true;
                updateSummary();
            } catch (error) {
                updateStatus('supabase-status', `‚ùå Failed to initialize Supabase: ${error.message}`, 'error');
                console.error('Supabase init error:', error);
            }
        }

        async function checkAuthentication() {
            try {
                if (!supabase) {
                    throw new Error('Supabase not initialized');
                }

                // Check if user is authenticated
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    currentUser = user;
                    updateStatus('auth-status', `‚úÖ User authenticated: ${user.email}`, 'success');
                    testResults.authCheck = true;
                } else {
                    updateStatus('auth-status', '‚ùå No user authenticated. Please log in to the main app first.', 'error');
                }
                updateSummary();
            } catch (error) {
                updateStatus('auth-status', `‚ùå Authentication check failed: ${error.message}`, 'error');
                console.error('Auth check error:', error);
            }
        }

        async function checkUserProfile() {
            try {
                if (!supabase || !currentUser) {
                    throw new Error('Supabase or user not available');
                }

                const { data, error } = await supabase
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error) throw error;

                if (data) {
                    userProfile = data;
                    updateStatus('profile-status', 
                        `‚úÖ User profile found: ${data.first_name} ${data.last_name} (${data.sub_district})`, 
                        'success'
                    );
                    testResults.profileCheck = true;
                } else {
                    updateStatus('profile-status', '‚ùå User profile not found', 'error');
                }
                updateSummary();
            } catch (error) {
                updateStatus('profile-status', `‚ùå Profile check failed: ${error.message}`, 'error');
                console.error('Profile check error:', error);
            }
        }

        async function testFacilityOptions() {
            try {
                if (!userProfile) {
                    throw new Error('User profile not loaded');
                }

                // Test the facility loading logic
                const PHC_FACILITIES = {
                    'Stellenbosch': [
                        'Aan-het-Pad Clinic',
                        'Groendal Clinic',
                        'Kylemore Clinic',
                        'Cloetesville CDC',
                        'Don & Pat Bilton Clinic',
                        'Klapmuts Clinic',
                        'Stellenbosch Provincial Hospital (inpatient)',
                        'Stellenbosch Intermediate Care Facility',
                        'Stellenbosch Provincial Hospital (outpatient)'
                    ]
                };

                const userSubDistrict = userProfile.sub_district;
                const facilities = PHC_FACILITIES[userSubDistrict] || [];

                if (facilities.length > 0) {
                    updateStatus('facility-status', 
                        `‚úÖ Facility options loaded for ${userSubDistrict}: ${facilities.length} facilities available`, 
                        'success'
                    );
                    testResults.facilityTest = true;
                } else {
                    updateStatus('facility-status', 
                        `‚ùå No facilities found for sub-district: ${userSubDistrict}`, 
                        'error'
                    );
                }
                updateSummary();
            } catch (error) {
                updateStatus('facility-status', `‚ùå Facility test failed: ${error.message}`, 'error');
                console.error('Facility test error:', error);
            }
        }

        async function createSamplePatient() {
            try {
                if (!supabase || !currentUser || !userProfile) {
                    throw new Error('Prerequisites not met');
                }

                // Create sample patient data matching the form structure
                const patientData = {
                    patient_identifier: 'TEST-PATIENT-001',
                    age_group: '>18',
                    facility_type: 'phc',
                    facility: 'Groendal Clinic', // From Stellenbosch facilities
                    appointment_date: new Date().toISOString().split('T')[0], // Today
                    appointment_type: 'new',
                    referral_source: 'hospital',
                    referral_source_other: '',
                    clinical_area: 'General Medicine',
                    clinical_area_other: '',
                    attendance: 'Attended',
                    disposal: 'Future Appointment Given',
                    outcome: 'Assessment Completed',
                    duration_minutes: 60,
                    activities: ['Assessment', 'Education And Recommendations'],
                    assistive_devices: {},
                    user_id: currentUser.id,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabase
                    .from('patient_records')
                    .insert([patientData])
                    .select()
                    .single();

                if (error) throw error;

                if (data) {
                    testPatientId = data.id;
                    updateStatus('create-status', 
                        `‚úÖ Patient record created successfully with ID: ${data.id}`, 
                        'success'
                    );
                    testResults.patientCreate = true;
                } else {
                    throw new Error('No data returned from insert');
                }
                updateSummary();
            } catch (error) {
                updateStatus('create-status', `‚ùå Patient creation failed: ${error.message}`, 'error');
                console.error('Patient creation error:', error);
            }
        }

        async function verifyPatientRecord() {
            try {
                if (!supabase || !testPatientId) {
                    throw new Error('No test patient ID to verify');
                }

                const { data, error } = await supabase
                    .from('patient_records')
                    .select('*')
                    .eq('id', testPatientId)
                    .single();

                if (error) throw error;

                if (data) {
                    updateStatus('verify-status', 
                        `‚úÖ Patient record verified: ${data.patient_identifier} (${data.facility})`, 
                        'success'
                    );
                    testResults.recordVerify = true;
                } else {
                    throw new Error('Patient record not found in database');
                }
                updateSummary();
            } catch (error) {
                updateStatus('verify-status', `‚ùå Verification failed: ${error.message}`, 'error');
                console.error('Verification error:', error);
            }
        }

        async function cleanupTestData() {
            try {
                if (!supabase || !testPatientId) {
                    updateStatus('cleanup-status', '‚ö†Ô∏è No test data to cleanup', 'info');
                    testResults.cleanup = true;
                    updateSummary();
                    return;
                }

                const { error } = await supabase
                    .from('patient_records')
                    .delete()
                    .eq('id', testPatientId);

                if (error) throw error;

                updateStatus('cleanup-status', '‚úÖ Test data cleaned up successfully', 'success');
                testResults.cleanup = true;
                testPatientId = null;
                updateSummary();
            } catch (error) {
                updateStatus('cleanup-status', `‚ùå Cleanup failed: ${error.message}`, 'error');
                console.error('Cleanup error:', error);
            }
        }

        // Auto-run all tests in sequence
        async function runAllTests() {
            await initializeSupabase();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await checkAuthentication();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await checkUserProfile();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testFacilityOptions();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await createSamplePatient();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await verifyPatientRecord();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await cleanupTestData();
        }

        // Initialize on page load
        updateSummary();
    </script>

    <div style="margin-top: 30px; padding: 20px; border-top: 1px solid #ddd;">
        <h3>üöÄ Quick Test</h3>
        <button onclick="runAllTests()" style="background: #28a745; padding: 15px 30px; font-size: 16px;">
            Run All Tests Automatically
        </button>
        <p><em>This will run all tests in sequence with small delays between each step.</em></p>
    </div>
</body>
</html>